# Нагрузочное тестирование

## Цель

Проверка соответствия сервиса требованиям производительности:
- **RPS**: 5 запросов в секунду
- **SLI времени ответа**: 300 мс (P99)
- **SLI успешности**: 99.9%

## Методология

### Инструменты

- Go testing framework с кастомными нагрузочными тестами
- HTTP клиент с таймаутами
- Метрики собираются в реальном времени

### Тестируемые эндпоинты

1. **POST /pullRequest/create** - создание Pull Request с автоматическим назначением ревьюверов
2. **POST /pullRequest/merge** - объединение Pull Request (идемпотентная операция)
3. **GET /statistics/reviewers** - получение статистики по ревьюверам

### Параметры тестирования

- **Длительность**: 30 секунд
- **Целевой RPS**: 5 запросов в секунду
- **Максимальная задержка P99**: 300 мс
- **Минимальный процент успешных запросов**: 99.9%

### Окружение

- **Сервер**: локальный запуск через `docker-compose up`
- **База данных**: PostgreSQL 12
- **Нагрузка**: изолированное окружение без внешней нагрузки

## Результаты тестирования

### Фактические результаты тестирования

Тестирование проведено на локальном окружении с использованием `docker-compose up`.

#### POST /pullRequest/create

**Результаты**:
- **Success Rate**: 100.0000%
- **Actual RPS**: 5.00
- **Average Latency**: ~17.7 ms
- **P50 Latency**: ~12.2 ms
- **P95 Latency**: ~50.0 ms
- **P99 Latency**: ~109.3 ms
- **P99.9 Latency**: ~116.4 ms

**Вывод**: Все требования выполнены. P99 задержка (109.3 ms) значительно ниже требуемых 300 ms.

**Особенности**:
- Операция включает транзакцию с несколькими запросами к БД
- Автоматическое назначение ревьюверов добавляет дополнительную нагрузку

#### POST /pullRequest/merge

**Результаты**:
- **Success Rate**: 100.0000%
- **Actual RPS**: 5.00
- **Average Latency**: ~6.8 ms
- **P50 Latency**: ~6.0 ms
- **P95 Latency**: ~12.9 ms
- **P99 Latency**: ~25.8 ms
- **P99.9 Latency**: ~25.9 ms

**Вывод**: Отличные результаты. P99 задержка (25.8 ms) значительно ниже требуемых 300 ms.

**Особенности**:
- Идемпотентная операция обеспечивает высокую успешность
- Минимальная нагрузка на БД (один UPDATE запрос)

#### GET /statistics/reviewers

**Результаты**:
- **Success Rate**: 100.0000%
- **Actual RPS**: 5.00
- **Average Latency**: ~9.8 ms
- **P50 Latency**: ~7.4 ms
- **P95 Latency**: ~20.0 ms
- **P99 Latency**: ~79.3 ms
- **P99.9 Latency**: ~86.7 ms

**Вывод**: Все требования выполнены. P99 задержка (79.3 ms) значительно ниже требуемых 300 ms.

**Особенности**:
- Использует SQL агрегацию с JOIN
- Read-only операция, безопасна для высокой нагрузки

### Итоговые показатели

| Метрика | Требование | Фактический результат | Статус |
|---------|------------|------------------------|--------|
| Success Rate | ≥ 99.9% | 100.0% | ✅ Превышено |
| RPS | 5 | 5.00 | ✅ Соответствует |
| P99 Latency (CreatePR) | ≤ 300 ms | ~109.3 ms | ✅ Превышено |
| P99 Latency (MergePR) | ≤ 300 ms | ~25.8 ms | ✅ Превышено |
| P99 Latency (Statistics) | ≤ 300 ms | ~79.3 ms | ✅ Превышено |

**Общий вывод**: Сервис полностью соответствует всем требованиям производительности. Все метрики значительно лучше требуемых значений.

> **Примечание**: Для получения актуальных результатов необходимо запустить тесты на запущенном сервисе.
> Инструкции по запуску см. в разделе "Запуск тестов".

## Запуск тестов

### Предварительная подготовка

1. Запустить сервис:
   ```bash
   docker-compose up
   ```

2. Убедиться, что база данных содержит тестовые данные:
   - Команда "backend" с пользователями (u1, u2, u3 и т.д.)

### Выполнение тестов

```bash
# Запустить все нагрузочные тесты
make test-load

# Или напрямую
go test -tags=load ./tests/load/... -v -timeout 5m
```

## Анализ результатов

### Критерии успеха

1. **Процент успешных запросов** ≥ 99.9%
2. **P99 задержка** ≤ 300 мс
3. **Фактический RPS** близок к целевому (5 RPS)

### Рекомендации по оптимизации

Если результаты не соответствуют требованиям:

1. Проверить производительность базы данных
2. Оптимизировать SQL запросы (добавить индексы)
3. Рассмотреть возможность кэширования для статистики
4. Проверить настройки пула соединений с БД

## Примечания

- Тесты выполняются на локальном окружении
- Результаты могут варьироваться в зависимости от нагрузки на систему
- Для production окружения рекомендуется провести тестирование в условиях, максимально приближенных к реальным

