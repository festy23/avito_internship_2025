# Руководство по развертыванию

## Требования

- Go 1.25.4+
- PostgreSQL 12+
- Docker и Docker Compose

## Быстрый старт

### Docker Compose

```bash
docker-compose up -d
```

Сервис доступен на порту 8080. PostgreSQL запускается автоматически, миграции применяются при старте.

Проверка работоспособности:

```bash
curl http://localhost:8080/health
```

### Локальное развертывание

1. Установите зависимости: `go mod download`
2. Настройте переменные окружения (см. раздел "Переменные окружения")
3. Запустите PostgreSQL: `docker-compose up postgres -d`
4. Запустите сервер: `go run cmd/server/main.go`

## Переменные окружения

### Сервер

- `SERVER_HOST` - хост сервера (по умолчанию: `""`)
- `SERVER_PORT` - порт сервера (по умолчанию: `:8080`)
- `SERVER_READ_TIMEOUT` - таймаут чтения (по умолчанию: `10s`)
- `SERVER_WRITE_TIMEOUT` - таймаут записи (по умолчанию: `10s`)
- `SERVER_IDLE_TIMEOUT` - таймаут простоя (по умолчанию: `120s`)
- `GIN_MODE` - режим Gin (по умолчанию: `release`)

### База данных

- `DB_HOST` - хост PostgreSQL (по умолчанию: `localhost`, в Docker: `postgres`)
- `DB_USER` - пользователь БД (по умолчанию: `postgres`)
- `DB_PASSWORD` - пароль БД (по умолчанию: `postgres`)
- `DB_NAME` - имя БД (по умолчанию: `avito_internship`)
- `DB_PORT` - порт PostgreSQL (по умолчанию: `5432`)
- `DB_SSLMODE` - режим SSL (по умолчанию: `disable`)
- `DB_TIMEZONE` - часовой пояс (по умолчанию: `UTC`)

### Повторные попытки подключения к БД

- `DB_RETRY_MAX_ATTEMPTS` - максимум попыток (по умолчанию: `5`)
- `DB_RETRY_INITIAL_DELAY` - начальная задержка (по умолчанию: `1s`)
- `DB_RETRY_MAX_DELAY` - максимальная задержка (по умолчанию: `30s`)
- `DB_RETRY_MULTIPLIER` - множитель задержки (по умолчанию: `2.0`)

### Логгер

- `LOG_LEVEL` - уровень логирования (по умолчанию: `info`)
- `LOG_FORMAT` - формат логов (`json` или `console`, по умолчанию: `json`)
- `LOG_OUTPUT` - вывод логов (по умолчанию: `stdout`)

### Миграции

- `MIGRATIONS_PATH` - путь к директории с миграциями (по умолчанию: `migrations`)

## Production развертывание

### Рекомендации

**Безопасность:**

- Используйте сильные пароли для БД
- Включите SSL для PostgreSQL (`DB_SSLMODE=require`)
- Настройте firewall для ограничения доступа к БД
- Используйте секреты для хранения паролей

**Производительность:**

- Настройте connection pool в PostgreSQL
- Используйте reverse proxy (nginx, traefik)
- Настройте мониторинг и логирование

**Надежность:**

- Настройте health checks для автоматического перезапуска
- Используйте orchestration (Kubernetes, Docker Swarm)
- Настройте резервное копирование БД

## Мониторинг

### Health Check

Сервис предоставляет endpoint для проверки состояния:

```bash
GET /health
```

Ответ включает статус сервиса и подключения к БД.

### Логирование

Логи выводятся в формате JSON (по умолчанию) или console. Уровни логирования:

- `debug`, `info`, `warn`, `error`

## Troubleshooting

### Проблемы с подключением к БД

1. Проверьте, что PostgreSQL запущен: `docker ps | grep postgres`

2. Проверьте переменные окружения: `env | grep DB_`

3. Проверьте логи: `docker-compose logs app`

### Проблемы с миграциями

Миграции применяются автоматически при старте. Если миграции не применяются:

1. Проверьте путь к миграциям (`MIGRATIONS_PATH`)
2. Проверьте права доступа к БД
3. Проверьте логи приложения

### Проблемы с портами

Если порт 8080 занят, измените `SERVER_PORT`:

```bash
export SERVER_PORT=:8081
```

## Откат изменений

Для отката миграций используйте файлы `.down.sql` из директории `migrations/`. Применяйте их вручную через psql в обратном порядке.

## Обновление

1. Остановите сервис: `docker-compose down`
2. Обновите код: `git pull`
3. Пересоберите образы: `docker-compose build`
4. Запустите сервис: `docker-compose up -d`

Миграции применятся автоматически при старте.
