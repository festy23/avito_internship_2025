# Нагрузочное тестирование

## Цель

Проверка соответствия сервиса требованиям производительности:
- **RPS**: 5 запросов в секунду
- **SLI времени ответа**: 300 мс (P99)
- **SLI успешности**: 99.9%

## Методология

### Инструменты

- Go testing framework с кастомными нагрузочными тестами
- HTTP клиент с таймаутами
- Метрики собираются в реальном времени

### Тестируемые эндпоинты

1. **POST /pullRequest/create** - создание Pull Request с автоматическим назначением ревьюверов
2. **POST /pullRequest/merge** - объединение Pull Request (идемпотентная операция)
3. **GET /statistics/reviewers** - получение статистики по ревьюверам

### Параметры тестирования

- **Длительность**: 30 секунд
- **Целевой RPS**: 5 запросов в секунду
- **Максимальная задержка P99**: 300 мс
- **Минимальный процент успешных запросов**: 99.9%

### Окружение

- **Сервер**: локальный запуск через `docker-compose up`
- **База данных**: PostgreSQL 12
- **Нагрузка**: изолированное окружение без внешней нагрузки

## Результаты тестирования

> **Примечание**: Для получения актуальных результатов необходимо запустить тесты на запущенном сервисе.
> Инструкции по запуску см. в разделе "Запуск тестов".

### POST /pullRequest/create

**Ожидаемые результаты**:
- Процент успешности: ≥ 99.9% (идемпотентность merge обеспечивает высокую успешность)
- P99 задержка: < 300 мс (операция включает создание PR и назначение ревьюверов)
- RPS: ~5 запросов в секунду

**Особенности**:
- Операция включает транзакцию с несколькими запросами к БД
- Автоматическое назначение ревьюверов добавляет дополнительную нагрузку

### POST /pullRequest/merge

**Ожидаемые результаты**:
- Процент успешности: ≥ 99.9% (идемпотентная операция)
- P99 задержка: < 100 мс (простая операция обновления статуса)
- RPS: ~5 запросов в секунду

**Особенности**:
- Идемпотентная операция обеспечивает высокую успешность
- Минимальная нагрузка на БД (один UPDATE запрос)

### GET /statistics/reviewers

**Ожидаемые результаты**:
- Процент успешности: ≥ 99.9% (read-only операция)
- P99 задержка: < 200 мс (агрегация данных с JOIN)
- RPS: ~5 запросов в секунду

**Особенности**:
- Использует SQL агрегацию с JOIN
- Read-only операция, безопасна для высокой нагрузки

## Запуск тестов

### Предварительная подготовка

1. Запустить сервис:
   ```bash
   docker-compose up
   ```

2. Убедиться, что база данных содержит тестовые данные:
   - Команда "backend" с пользователями (u1, u2, u3 и т.д.)

### Выполнение тестов

```bash
# Запустить все нагрузочные тесты
make test-load

# Или напрямую
go test -tags=load ./tests/load/... -v -timeout 5m
```

## Анализ результатов

### Критерии успеха

1. **Процент успешных запросов** ≥ 99.9%
2. **P99 задержка** ≤ 300 мс
3. **Фактический RPS** близок к целевому (5 RPS)

### Рекомендации по оптимизации

Если результаты не соответствуют требованиям:

1. Проверить производительность базы данных
2. Оптимизировать SQL запросы (добавить индексы)
3. Рассмотреть возможность кэширования для статистики
4. Проверить настройки пула соединений с БД

## Примечания

- Тесты выполняются на локальном окружении
- Результаты могут варьироваться в зависимости от нагрузки на систему
- Для production окружения рекомендуется провести тестирование в условиях, максимально приближенных к реальным

